<html>
<head>
<style>
html, body {
	width: 100%;
	height: 100%;
	margin: 0;
	padding: 0;
	font-family: "Helvetica Neue", Helvetica, sans-serif;
}
#pmap {
	width: 100%;
	height: 100%;
	top: 0;
	left: 0;
}
svg path.edge {
	stroke: #404040;
	stroke-width: 0.05;
	fill: none;
}
svg path.edge.selected {
	stroke: #804040;
	stroke-width: 0.07;
	fill: none;
}
svg path.face {
	stroke: none;
	fill: #ffaaaa;
}
svg path.face.selected {
	stroke: none;
	fill: #ff7777;
}
svg .cornerLayer path {
	stroke: none;
	fill: #ff2222;
}
svg text.label {
	pointer-events: none;
	font-family: Verdana;
	font-size: 0.3;
}
svg circle.node {
	fill: #4040d0;
}
svg circle.node.selected {
	fill: #a040d0;
}
div#title {
	z-index:101; 
	position:absolute;
	top:10px;
	left:30px;
}
#title h1 {
	color: black;
	font-weight: 300;
	font-size: 32px;
	text-rendering: optimizeLegibility;
	margin-bottom:0px;
}
</style>
</head>
<body>
	
<div id="title">
	<h1>Editor</h1>
</div>

<div class="panelcontainer"></div>
<div id="pmap"></div>


<script charset="utf-8" src="../thirdparty/d3/d3.js"></script>
<script src="../src/geometry.js"></script>
<script src="../src/layout.js"></script>
<script src="../src/force.js"></script>
<script src="../src/planarmap.js"></script>
<script src="../src/view.js"></script>
<script src="../src/algorithms.js"></script>
<script src="planarmap.jsonp"></script>
<script>

var svg = d3.select("#pmap").append("svg")
	.attr("id","pmapsvg")
	.attr("width","100%")
	.attr("height","100%")
	.attr("viewBox","-8 -5 16 10")
	.attr("preserveAspectRatio", "xMidYMid meet")	
	
var planarmap = CMap.PlanarMap().fromJSON(mapdata);
var layoutupdater = CMap.LayoutUpdater()
	.registerAll(planarmap);
	
var view = CMap.View(planarmap,svg).zoom();
view.nodeText(function(node){
	return node.attr.id ;
}).updateLayers();

var times2 = [];
var force = CMap.force(planarmap)
	.centerPull({pull: true, center: new Vec2(0,0), coupling: 0.1})
	.stretchForce(true)
	.on("tick",function(){ 
		layoutupdater.attemptStretch(planarmap);
		times2.push(window.performance.now());
		if( times2.length > 500 )
    	{
			//debugger;
			times2.splice(0,times2.length-500);
		}
		view.updatePositions();
	})
	.resume();

d3.select("body").on("keydown",function(){
	if( d3.event.keyCode == 46 ) // Delete
	{
		var selection = view.getSelection();
		if( selection.faces.length == 0 &&
			selection.nodes.length == 0 &&
			selection.corners.length == 0 &&
			selection.edges.length == 1 )
		{
			var edge = selection.edges[0];
			if( !(edge.start.edges.length > 1 && edge.end.edges.length > 1
				&& edge.left == edge.right) && planarmap.numEdges() > 1 )
			{

				view.clearSelection();
				force.stop();
				planarmap.removeEdge(edge);
				view.updateLayers();
				force.resume();
			}
		}
	} else if ( d3.event.keyCode == 69 ) // E
	{
		var selection = view.getSelection();
		if( selection.faces.length == 0 &&
			selection.nodes.length == 0 &&
			selection.edges.length == 0 )	
		{
			if( selection.corners.length == 1 )
			{
				var edge = selection.corners[0];
				view.clearSelection();
				planarmap.insertEdgeNextTo(edge);
				view.updateLayers();
			} else if( selection.corners.length == 2 
				&& selection.corners[0].left() ==
				   selection.corners[1].left() )
			{
				var edge1 = selection.corners[0],
					edge2 = selection.corners[1];
				view.clearSelection();
				planarmap.insertDiagonal(edge1.left(),[edge1,edge2]);
				view.updateLayers();
			}
		}	
		
	} else if ( d3.event.keyCode == 82 ) // R
	{
		force.resume();
	} else if ( d3.event.keyCode == 83 ) // S
	{
		force.stop();
	}
	
});

</script>
</body>
</html>

