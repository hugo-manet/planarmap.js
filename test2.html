<html>
<head>
<style>
.link {
	stroke: #999;
}
.forcevec {
	stroke: red;
}
svg {
	border: 1px solid black;
}
</style>
</head>
<body>
<div id="pmap">
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.4.1/d3.min.js"></script>
<script src="rbtree.js"></script>
<script src="force.js"></script>
<script>
var svg = d3.select("#pmap").append("svg")
	.attr("width",1000).attr("height",500);

var nodes = [{x: 1., y: 0.}, {x: 0.309017, y: 0.951057}, {x: -0.809017, y: 0.587785}, 
			 {x: -0.809017, y: -0.587785}, {x: 0.309017, y: -0.951057}, {x: 0.4, y: 0.2}, 
			 {x: 2., y: 0.}, {x: 2., y: 3.}, {x: 1., y: 1.}, {x: 1.2, y: 1.}
			].map(function(p){return {pos: new Vec2(p.x,p.y)};});
		 
var links = [ [0,1], [1,2], [2,3], [3,4], [4,0], 
			  [0,5], [4,6], [6,0], [1,7], [7,2], 
			  [6,7], [0,8], [8,9], [9,0] ];
var faces = [{links: [{id:0,ccw:true}, {id:1,ccw:true}, {id:2,ccw:true}, {id:3,ccw:true}, 
					  {id:4,ccw:true}, {id:5,ccw:true},{id:5,ccw:false}], 
			  outer: false,
			  color: "#f0f0ff"}, 
			 {links: [{id:4,ccw:false},{id:6,ccw:true},{id:7,ccw:true}], 
			  outer: false,
			  color: "#f0f0ff"},
			 {links: [{id:8,ccw:true},{id:9,ccw:true},{id:1,ccw:false}],
			  outer: false,
			  color: "#f0f0ff"},
			 {links: [{id:7,ccw:false},{id:10,ccw:true},{id:8,ccw:false},{id:0,ccw:false},
			 		  {id:11,ccw:true},{id:12,ccw:true},{id:13,ccw:true}], 
			  outer: false,
			  color: "#f0f0ff"},
			 {links: [{id:13,ccw:false},{id:12,ccw:false},{id:11,ccw:false}],
			  outer: false,
			  color: "#f0f0ff"},
			 {links: [{id:9,ccw:false},{id:10,ccw:false},{id:6,ccw:false},
			 		  {id:3,ccw:false},{id:2,ccw:false}],
			  outer: true,
			  color: "#f0f0ff"}];

var scale = 60;
var offset = {x: 500, y: 250};
function toScreenCoor(d)
{
	return {x:scale*d.x + offset.x,y:-scale*d.y + offset.y};
}
function fromScreenCoor(c)
{
	return new Vec2((c.x-offset.x)/scale,(-c.y+offset.y)/scale);
}


var force = CMap.force().nodes(nodes)
	.faces(faces)
	.links(links)
	.clip({use: false, minX: fromScreenCoor({x:0,y:svg.attr("height")}).x,
					  minY: fromScreenCoor({x:0,y:svg.attr("height")}).y,
					  maxX: fromScreenCoor({x:svg.attr("width"),y:0}).x,
					  maxY: fromScreenCoor({x:svg.attr("width"),y:0}).y})
	.centerPull({pull: true, center: new Vec2(0,0), coupling: 0.4})
	.on("tick",updateMap);

var linkgroup = svg.selectAll("g.face")
	.data(faces)
	.enter()
	.append("g")
	.attr("class","face");

var facePolygons = linkgroup.selectAll("polygon")
	.data(function(d) { return (d.outer?[]:[d]); })
	.enter().append("polygon")
	.attr("fill",function(d){return d.color;} )
	.attr("fill-opacity",0)
	.attr("stroke","")
	.on("mouseover",function(d,i) { d3.select(this).style("fill-opacity",1);})
	.on("mouseout",function(d,i) { d3.select(this).style("fill-opacity",0);})

var linkLines = linkgroup.selectAll("line.link")
	.data(function(d) { return d.links;	})
	.enter().append("line")
	.attr("class","link");

var drag = d3.behavior.drag()
	.origin(function(d){return d;})
	.on("drag", dragmove)
	.on("dragstart", dragstart)
	.on("dragend", dragend);
	
var nodeGroups = svg.selectAll("circle.node")
   	.data(nodes)
   	.enter()
   	.append("g");
   	
var nodeCircles = nodeGroups.append("circle")
   	.attr("class","node")
   	.attr("r", "7px")
   	.attr("fill", "blue")
 	.call(drag);
var nodeLabels = nodeGroups.append("text")
	.attr("dx",9)
	.style("text-anchor","start")
	.text(function(d,i) {return i;});

/*   	
var forceLines = svg.selectAll("line.forcevec")
	.data(nodes)
	.enter()
	.append("line")
	.attr("class","forcevec");
*/

function dragstart(d)
{
	force.dragforce().drag = true;
	force.dragforce().node = d;
//	console.log(d3.event);

	//var x = new Vec2(d3.mouse(this)[0],d3.mouse(this)[1]);
	force.dragforce().cursor = fromScreenCoor(d3.event.sourceEvent);
	force.resume();
}
function dragmove(d)
{
	//var x = new Vec2(d3.mouse(this)[0],d3.mouse(this)[1]);
	//force.dragforce().cursor = fromScreenCoor(x);
	force.dragforce().cursor = fromScreenCoor(d3.event.sourceEvent);
	force.resume();
}
function dragend(d)
{
	force.dragforce().drag = false;
}

function updateMap()
{
//	nodeCircles
//   	.attr("cx", function(d) { return toScreenCoor(d.pos).x; })
//   	.attr("cy", function(d) { return toScreenCoor(d.pos).y; });
	nodeGroups.attr("transform", function(d){
		return "translate(" + [toScreenCoor(d.pos).x,toScreenCoor(d.pos).y] + ")";
   	});


	linkLines
	.attr("x1", function(d) { return toScreenCoor(nodes[links[d.id][0]].pos).x; })
	.attr("y1", function(d) { return toScreenCoor(nodes[links[d.id][0]].pos).y; })
	.attr("x2", function(d) { return toScreenCoor(nodes[links[d.id][1]].pos).x; })
	.attr("y2", function(d) { return toScreenCoor(nodes[links[d.id][1]].pos).y; });
	
	/*
	forceLines
	.attr("x1", function(d) { return toScreenCoor(d.pos).x; })
	.attr("y1", function(d) { return toScreenCoor(d.pos).y; })
	.attr("x2", function(d) { return toScreenCoor(d.pos.copy().addVec(d.force.copy().mult(0.02))).x; })
	.attr("y2", function(d) { return toScreenCoor(d.pos.copy().addVec(d.force.copy().mult(0.02))).y; });
	*/
	
	facePolygons.attr("points",function(d) {
		return d.links.map(function(p) { 
			var coor = toScreenCoor(nodes[links[p.id][(p.ccw?0:1)]].pos);
			return [coor.x,coor.y].join(","); 
		}).join(" ");
	});
	/*facePolygons.attr("fill",function(d) {
		return (CMap.faceIsNonSimple(d,links,nodes) ? "red" : "#ccffcc");
	});*/
}

force.start();

</script>
</body>
</html>
